<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ประวัติการรักษา: <%= patient.first_name %> | Dentist Clinic System</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"> 
  <link rel="stylesheet" href="/public/css/styles.css"/> 
  <link rel="stylesheet" href="/public/css/history-custom.css"/> 
</head>
<body data-user-role="<%= userRole %>">

  <!-- success toast -->
  <div id="success-alert" class="alert alert-success alert-dismissible fade show" role="alert"
       style="display:none; position:fixed; top:80px; right:20px; z-index:1050;">
    <div id="success-alert-message"></div>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="patient-name-header"><%= patient.first_name %> <%= patient.last_name %></h3>
        <div class="patient-info-chips">
          <span class="chip">CN: <%= patient.clinic_number %></span>
          <% if (typeof patient.age !== 'undefined' && patient.age !== null) { %>
            <span class="chip">อายุ: <%= patient.age %> ปี</span>
          <% } %>
          <% if (patient.gender) { %>
            <span class="chip">เพศ: <%= patient.gender %></span>
          <% } %>
        </div>
      </div>
      <div>
        <% if (userRole === 'dentist') { %>
          <a href="/dentist/new/<%= patient.id %>" class="btn btn-primary">+ บันทึกการรักษา</a>
          <a href="/dentist/patients" class="btn btn-secondary">กลับไปหน้ารายชื่อ</a>
        <% } %>
        <% if (userRole === 'staff') { %>
          <a href="/staff/<%= patient.id %>/edit" class="btn btn-warning">แก้ไขข้อมูลคนไข้</a>
          <a href="/staff/patients" class="btn btn-secondary">กลับไปหน้ารายชื่อ</a>
        <% } %>
      </div>
    </div>

    <div class="main-content">
      <!-- Left: list -->
      <div class="panel list-panel">
        <div class="history-toolbar">
          <div class="search-wrapper">
            <i class="fa-solid fa-magnifying-glass" style="color: var(--text-muted)"></i>
            <input type="search" id="search-input" placeholder="ค้นหา (หัตถการ/หมายเหตุ)">
          </div>
          <div class="date-group">
            <label for="start-date-input">จาก</label>
            <input type="date" id="start-date-input">
          </div>
          <div class="date-group">
            <label for="end-date-input">ถึง</label>
            <input type="date" id="end-date-input">
          </div>
        </div>

        <div class="visit-scroll">
          <div class="visit-list-header">
            <div>วันที่ / เวลา</div>
            <div>หัตถการ / สรุป</div>
            <div>การชำระเงิน</div>
            <div>สถานะ</div>
          </div>

          <div class="visit-list-body" id="visit-list-body">
            <% if (visits.length > 0) { %>
              <% visits.forEach((v, idx) => {
                   const proc = v.procedure_code || '-';
                   const note = v.notes || '';
                   const payText = (v.payment_status || '').toLowerCase() === 'paid' ? 'ชำระแล้ว' : 'ยังไม่ชำระ';
                   const searchText = (proc + ' ' + note).toLowerCase();
              %>
                <a href="#" class="visit-item <%= idx === 0 ? 'active' : '' %>"
                   data-visit-id="<%= v.id %>"
                   data-search-text="<%= searchText %>"
                   data-visit-date-iso="<%= new Date(v.visit_date).toISOString().split('T')[0] %>">
                  <div><%= new Date(v.visit_date).toLocaleString('sv-SE', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }) %></div>
                  <div><%= proc %></div>
                  <div><%= (v.payment_amount ? Number(v.payment_amount).toLocaleString('th-TH', { minimumFractionDigits:2 }) + ' ฿' : '-') %></div>
                  <div>
                    <span class="badge <%= (v.payment_status||'').toLowerCase()==='paid' ? 'badge-success' : 'badge-warning' %>">
                      <%= payText %>
                    </span>
                  </div>
                </a>
              <% }); %>
            <% } else { %>
              <div class="text-center p-4 text-muted">ไม่มีประวัติการรักษา</div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Right: detail -->
      <div class="panel detail-panel">
        <div class="detail-scroll">
          <div class="detail-panel-header" id="detail-header">รายละเอียดการรักษา</div>
          <div class="detail-content" id="detail-content"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- embed visits -->
  <script type="application/json" id="visits-data"><%- JSON.stringify(visits) %></script>

  <script nonce="<%= locals.nonce %>">
  document.addEventListener('DOMContentLoaded', () => {
    // toast from query ?success_message=
    const urlParams = new URLSearchParams(window.location.search);
    const msg = urlParams.get('success_message');
    if (msg) {
      $('#success-alert-message').text(decodeURIComponent(msg));
      $('#success-alert').show();
      setTimeout(() => $('#success-alert').fadeOut('slow'), 4000);
    }

    const raw = document.getElementById('visits-data').textContent;
    const visits = JSON.parse(raw);
    const vmap = new Map(visits.map(v => [String(v.id), v]));

    const listBody = document.getElementById('visit-list-body');
    const detailHeader = document.getElementById('detail-header');
    const detailContent = document.getElementById('detail-content');
    const searchInput = document.getElementById('search-input');
    const startDateInput = document.getElementById('start-date-input');
    const endDateInput = document.getElementById('end-date-input');

    function normalizeImgSrc(p) {
      if (!p) return '';
      if (/^https?:\/\//i.test(p)) return p;                // S3 URL
      if (p.startsWith('public/')) return '/' + p;          // ไฟล์เดิมในเครื่อง
      return '/public' + p;                                  // กันกรณีเก่า
    }

    function renderDetail(id) {
      const v = vmap.get(String(id));
      if (!v) {
        detailHeader.textContent = 'รายละเอียดการรักษา';
        detailContent.innerHTML = '<div class="detail-content-empty">เลือกรายการจากด้านซ้ายเพื่อดูรายละเอียด</div>';
        return;
      }
      const dt = new Date(v.visit_date).toLocaleString('th-TH', { year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' });
      detailHeader.textContent = `รายละเอียด (${dt})`;

      // parse images (JSON array) from v.xray_s3_urls; fallback to xray_images_list
      let imgs = [];
      try { imgs = JSON.parse(v.xray_s3_urls || '[]'); } catch(_) {}
      if (!Array.isArray(imgs) || imgs.length===0) {
        try { imgs = JSON.parse(v.xray_images_list || '[]'); } catch(_) {}
      }

      const gallery = (imgs||[]).map(p => {
        const url = normalizeImgSrc(p);
        return `<div class="col-md-4 mb-2"><a href="${url}" target="_blank"><img src="${url}" class="img-fluid rounded" loading="lazy"></a></div>`;
      }).join('');

      const payText = (v.payment_status || '').toLowerCase() === 'paid' ? 'ชำระแล้ว' : 'ยังไม่ชำระ';
      const payHtml = `
        <div class="detail-section">
          <h5><i class="fas fa-file-invoice-dollar"></i> การชำระเงิน</h5>
          <p>
            <strong>สถานะ:</strong>
            <span class="badge ${payText==='ชำระแล้ว'?'badge-success':'badge-warning'}">${payText}</span><br>
            <strong>จำนวน:</strong> ${v.payment_amount ? Number(v.payment_amount).toLocaleString('th-TH', { minimumFractionDigits:2 }) + ' บาท' : '-'}<br>
            <strong>วันที่ชำระ:</strong> ${v.payment_date ? new Date(v.payment_date).toLocaleString('th-TH') : '-'}
          </p>
        </div>`;

      detailContent.innerHTML = `
        <div class="detail-section">
          <h5>หัตถการ</h5>
          <p>${v.procedure_code || '-'}</p>
        </div>
        <div class="detail-section">
          <h5>บันทึก/หมายเหตุ</h5>
          <p>${v.notes ? v.notes.replace(/\n/g,'<br>') : 'ไม่มีบันทึก'}</p>
        </div>
        ${imgs && imgs.length ? `<div class="detail-section"><h5>X-Ray Images</h5><div class="row">${gallery}</div></div>` : ''}
        ${payHtml}
      `;
    }

    function filterList() {
      const q = (searchInput.value || '').toLowerCase();
      const s = startDateInput.value;
      const e = endDateInput.value;

      let firstVisible = null;
      listBody.querySelectorAll('.visit-item').forEach(item => {
        const text = item.dataset.searchText || '';
        const d = item.dataset.visitDateIso || '';
        const ok = (!q || text.includes(q)) && (!s || d >= s) && (!e || d <= e);
        item.style.display = ok ? 'grid' : 'none';
        if (ok && !firstVisible) firstVisible = item;
      });

      const active = listBody.querySelector('.visit-item.active');
      if (!active || active.style.display === 'none') {
        listBody.querySelectorAll('.visit-item').forEach(i => i.classList.remove('active'));
        if (firstVisible) {
          firstVisible.classList.add('active');
          renderDetail(firstVisible.dataset.visitId);
        } else {
          renderDetail(null);
        }
      }
    }

    listBody.addEventListener('click', e => {
      const a = e.target.closest('.visit-item');
      if (!a) return;
      e.preventDefault();
      if (!a.classList.contains('active')) {
        listBody.querySelectorAll('.visit-item').forEach(i => i.classList.remove('active'));
        a.classList.add('active');
      }
      renderDetail(a.dataset.visitId);
    });

    [searchInput, startDateInput, endDateInput].forEach(el => el.addEventListener('input', () => requestAnimationFrame(filterList)));

    const initial = listBody.querySelector('.visit-item.active') || listBody.querySelector('.visit-item');
    if (initial) {
      initial.classList.add('active');
      renderDetail(initial.dataset.visitId);
    } else {
      renderDetail(null);
    }
  });
  </script>
</body>
</html>