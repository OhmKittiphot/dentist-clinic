<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ประวัติการรักษา | DentalCare</title>
  <link rel="stylesheet" href="/public/css/medical_history.css"/>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <nav class="nav">
        <a class="active" href="/patients">เวชระเบียน</a>
        <a href="#">นัดหมาย</a>
        <a href="#">ชำระเงิน</a>
      </nav>
    </aside>

    <main class="main">
      <div class="header">
        <div class="name"><%= patient.first_name %> <%= patient.last_name %></div>
        <div class="chips">
          <span class="chip">CN: <%= patient.clinic_number %></span>
        </div>
      </div>

      <div class="toolbar">
        <div class="search">
          <input id="q" type="search" placeholder="ค้นหา (แพทย์/หัตถการ/หมายเหตุ)"/>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.3-4.3M3 11a8 8 0 1016 0 8 8 0 10-16 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <div class="range">
          <label class="chip" style="background:#fff">จาก <input id="from" type="date"></label>
          <label class="chip" style="background:#fff">ถึง <input id="to" type="date"></label>
        </div>
      </div>

      <div class="split">
        <section class="card">
          <header class="list-head">
            <div>วันที่ / เวลา</div>
            <div>หัตถการ / สรุป</div>
            <div>ทันตแพทย์</div>
          </header>
          <div id="list" class="list" role="list"></div>
        </section>

        <section class="card detail" aria-live="polite">
          <div class="detail-head">
            <div class="detail-title" id="title">เลือกแถวจากด้านซ้ายเพื่อดูรายละเอียด</div>
          </div>
          <div class="detail-body">
            <div class="group">
              <h4>Vital Signs</h4>
              <div class="kv"><div>ค่าวัด</div><div id="vitals">—</div></div>
            </div>
            <div class="group">
              <h4>รายการหัตถการ</h4>
              <div id="procedures">—</div>
            </div>
            <div class="group">
              <h4>บันทึก/ข้อสังเกต</h4>
              <div id="notes">—</div>
            </div>
          </div>
          <div class="footer"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // Build history array from server-side data
    const HISTORY = <%- JSON.stringify(
      (visits || []).map(v => ({
        id: v.id,
        dt: (v.visit_date || '').slice ? v.visit_date.slice(0,16).replace('T',' ') : v.visit_date,
        doctor: v.doctor_name || '',
        summary: ( ( (procMap.get(v.id)||[]).map(p=>p.code + (p.tooth_no? ' ('+p.tooth_no+')':'')) ).join(', ') ) || '—',
        procedures: (procMap.get(v.id)||[]).map(p=> (`${p.code}${p.tooth_no ? ` (ซี่ ${p.tooth_no})` : ''} - ค่าใช้จ่าย: ${p.qty * p.price_each} บาท`)),
        vitals: (v.bp_sys||v.bp_dia) ? `BP ${v.bp_sys||'-'}/${v.bp_dia||'-'}` : '—',
        notes: v.clinical_notes || ''
      }))
    ) %>;
  </script>
  <script>
    const listEl = document.getElementById('list');
    const titleEl = document.getElementById('title');
    const vitalsEl = document.getElementById('vitals');
    const proceduresEl = document.getElementById('procedures');
    const notesEl = document.getElementById('notes');
    const qEl = document.getElementById('q');
    const fromEl = document.getElementById('from');
    const toEl = document.getElementById('to');
    let activeId = null;

    function filtered(){
      const q = (qEl.value||'').toLowerCase();
      const from = fromEl.value ? new Date(fromEl.value) : null;
      const to = toEl.value ? new Date(toEl.value+'T23:59:59') : null;
      return HISTORY.filter(x => {
        const matchQ = !q || (x.doctor + x.summary + (x.notes||'')).toLowerCase().includes(q);
        const d = new Date(x.dt.replace(' ', 'T'));
        const inFrom = !from || d >= from;
        const inTo = !to || d <= to;
        return matchQ && inFrom && inTo;
      }).sort((a,b)=> new Date(b.dt) - new Date(a.dt));
    }

    function renderList(){
      const rows = filtered();
      listEl.innerHTML = '';
      rows.forEach(x => {
        const row = document.createElement('div');
        row.className = 'row' + (x.id===activeId ? ' active':'');
        row.innerHTML = `<div>${x.dt}</div><div class="summary">${x.summary}</div><div>${x.doctor||''}</div>`;
        row.addEventListener('click', ()=> select(x.id));
        listEl.appendChild(row);
      });
      if (!rows.find(r => r.id === activeId)) select(rows[0]?.id || null);
    }

    function select(id){
      activeId = id;
      [...listEl.children].forEach(el => {
        const tdt = el.querySelector('div').textContent;
        el.classList.toggle('active', (HISTORY.find(h => h.dt === tdt)?.id) === id);
      });
      const data = HISTORY.find(x=>x.id===id);
      if(!data){ titleEl.textContent = 'เลือกแถวจากด้านซ้ายเพื่อดูรายละเอียด'; vitalsEl.textContent='—'; proceduresEl.textContent='—'; notesEl.textContent='—'; return; }
      titleEl.textContent = `${data.dt} • ${data.doctor||'-'}`;
      vitalsEl.textContent = data.vitals || '—';
      proceduresEl.innerHTML = data.procedures?.length ? `<ul style="margin:6px 0 0 18px">${data.procedures.map(p=>`<li>${p}</li>`).join('')}</ul>` : '—';
      notesEl.textContent = data.notes || '—';
    }

    qEl.addEventListener('input', renderList);
    fromEl.addEventListener('change', renderList);
    toEl.addEventListener('change', renderList);
    renderList();
  </script>
</body>
</html>