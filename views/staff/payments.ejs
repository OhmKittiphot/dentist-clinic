<!DOCTYPE html>
<html lang="th">
<head>
  <%- include('../partials/head') %>
  <link rel="stylesheet" href="/public/css/staff-payments.css" />
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</title>
</head>

<body>
  <div class="app">
    <%- include('../partials/navbar') %>
    <main class="main-content">
      <div class="container">
        <h1 class="mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>

        <!-- üîé Toolbar ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á -->
        <form class="payments-toolbar" method="GET" action="">
          <input type="hidden" name="page" value="1" />
          <input type="hidden" name="pageSize" value="<%= pageSize %>" />

          <div class="toolbar-row">
            <div class="toolbar-field">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
              <input type="text" name="q" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                     value="<%= q || '' %>">
            </div>

            <div class="toolbar-field">
              <label>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" name="date_from" value="<%= date_from || '' %>">
            </div>

            <div class="toolbar-field">
              <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" name="date_to" value="<%= date_to || '' %>">
            </div>

            <div class="toolbar-actions">
              <button type="submit" class="btn primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              <a href="/staff/payments?page=1&pageSize=<%= pageSize %>" class="btn ghost">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</a>
            </div>
          </div>
        </form>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ Visit/Staff ID) -->
        <div class="payments-table">
          <div class="payments-thead">
            <div>ID</div>
            <div>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
            <div>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ø)</div>
            <div>‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</div>
            <div>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <div>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
          </div>

          <% if (!payments || payments.length === 0) { %>
            <div class="empty-payments">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
          <% } else { %>
            <% payments.forEach(p => { %>
              <div class="payments-trow">
                <div><%= p.id %></div>
                <div><%= p.patient_name || '-' %></div>
                <div><%= typeof p.amount === 'number' ? p.amount.toFixed(2) : '-' %></div>
                <div>
                  <%= p.payment_date
                        ? new Date(p.payment_date).toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' })
                        : '-' %>
                </div>
                <div>
                  <% if (p.status === 'paid') { %>
                    <span class="status-badge status-paid">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</span>
                  <% } else { %>
                    <span class="status-badge status-pending">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</span>
                  <% } %>
                </div>
                <div>
                  <% if (p.status === 'pending') { %>
                    <form action="/staff/payments/<%= p.id %>/complete?page=<%= page %>&pageSize=<%= pageSize %>&q=<%- encodeURIComponent(q || '') %>&date_from=<%= date_from || '' %>&date_to=<%= date_to || '' %>" method="POST" style="display:inline;">
                      <button type="submit" class="btn success">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</button>
                    </form>
                  <% } else { %>
                    <span>-</span>
                  <% } %>
                </div>
              </div>
            <% }) %>
          <% } %>
        </div>

        <!-- Pagination -->
        <nav class="pager" aria-label="pagination">
          <div class="pager-left">
            <% if (page > 1) { %>
              <a class="pager-btn" href="?page=<%= page - 1 %>&pageSize=<%= pageSize %>&q=<%- encodeURIComponent(q || '') %>&date_from=<%= date_from || '' %>&date_to=<%= date_to || '' %>">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</a>
            <% } else { %>
              <span class="pager-btn disabled">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>
            <% } %>
          </div>

          <div class="pager-pages">
            <% 
              const windowSize = 2;
              const startPage = Math.max(1, page - windowSize);
              const endPage = Math.min(totalPages, page + windowSize);
            %>

            <% if (startPage > 1) { %>
              <a class="pager-num" href="?page=1&pageSize=<%= pageSize %>&q=<%- encodeURIComponent(q || '') %>&date_from=<%= date_from || '' %>&date_to=<%= date_to || '' %>">1</a>
              <% if (startPage > 2) { %><span class="pager-ellipsis">‚Ä¶</span><% } %>
            <% } %>

            <% for (let i = startPage; i <= endPage; i++) { %>
              <% if (i === page) { %>
                <span class="pager-num active"><%= i %></span>
              <% } else { %>
                <a class="pager-num" href="?page=<%= i %>&pageSize=<%= pageSize %>&q=<%- encodeURIComponent(q || '') %>&date_from=<%= date_from || '' %>&date_to=<%= date_to || '' %>"><%= i %></a>
              <% } %>
            <% } %>

            <% if (endPage < totalPages) { %>
              <% if (endPage < totalPages - 1) { %><span class="pager-ellipsis">‚Ä¶</span><% } %>
              <a class="pager-num" href="?page=<%= totalPages %>&pageSize=<%= pageSize %>&q=<%- encodeURIComponent(q || '') %>&date_from=<%= date_from || '' %>&date_to=<%= date_to || '' %>"><%= totalPages %></a>
            <% } %>
          </div>

          <div class="pager-right">
            <% if (page < totalPages) { %>
              <a class="pager-btn" href="?page=<%= page + 1 %>&pageSize=<%= pageSize %>&q=<%- encodeURIComponent(q || '') %>&date_from=<%= date_from || '' %>&date_to=<%= date_to || '' %>">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>
            <% } else { %>
              <span class="pager-btn disabled">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</span>
            <% } %>
          </div>
        </nav>

        <!-- Page size selector -->
        <form class="page-size-form" method="GET">
          <input type="hidden" name="page" value="1" />
          <input type="hidden" name="q" value="<%= q || '' %>" />
          <input type="hidden" name="date_from" value="<%= date_from || '' %>" />
          <input type="hidden" name="date_to" value="<%= date_to || '' %>" />
          <label>‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤:</label>
          <select name="pageSize" onchange="this.form.submit()">
            <option value="10" <%= pageSize==10 ? 'selected' : '' %>>10</option>
            <option value="20" <%= pageSize==20 ? 'selected' : '' %>>20</option>
            <option value="50" <%= pageSize==50 ? 'selected' : '' %>>50</option>
          </select>
          <span class="muted">‡∏£‡∏ß‡∏° <%= total %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        </form>

      </div>
    </main>
  </div>

  <script nonce="<%= nonce %>"></script>
</body>
</html>
